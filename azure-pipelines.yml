trigger:
  branches:
    include:
      - main
      - master

variables:
  OPENCV_VERSION: '4.10.0'
  ONNX_VERSION: '1.19.2'
  GO_VERSION: '1.23.0'

stages:
  - stage: Build
    jobs:
      # ==================== macOS ARM64 构建 ====================
      - job: macOS
        pool:
          vmImage: 'macOS-latest'
        timeoutInMinutes: 120
        steps:
          - task: GoTool@0
            inputs:
              version: '$(GO_VERSION)'
            displayName: '安装 Go'

          - script: |
              set -e
              echo "=== 安装依赖 ==="
              brew install cmake ninja pkg-config jpeg-turbo libpng libtiff webp openjpeg zlib || true
              go install github.com/wailsapp/wails/v2/cmd/wails@latest
              echo "##vso[task.prependpath]$(go env GOPATH)/bin"
            displayName: '安装依赖'

          - script: |
              set -e
              echo "=== 下载 OpenCV ==="
              curl -sL "https://github.com/opencv/opencv/archive/refs/tags/$(OPENCV_VERSION).tar.gz" | tar xz
              curl -sL "https://github.com/opencv/opencv_contrib/archive/refs/tags/$(OPENCV_VERSION).tar.gz" | tar xz
              
              echo "=== 编译 OpenCV ==="
              mkdir -p opencv-$(OPENCV_VERSION)/build
              cd opencv-$(OPENCV_VERSION)/build
              cmake .. -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=$HOME/opencv-minimal \
                -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-$(OPENCV_VERSION)/modules \
                -DBUILD_LIST=core,imgproc,imgcodecs,features2d,flann,calib3d,xfeatures2d \
                -DWITH_QT=OFF -DWITH_GTK=OFF -DWITH_FFMPEG=OFF -DWITH_GSTREAMER=OFF \
                -DWITH_AVFOUNDATION=OFF -DWITH_VTK=OFF -DWITH_OPENGL=OFF -DWITH_OPENCL=OFF \
                -DWITH_IPP=OFF -DWITH_TBB=OFF -DWITH_LAPACK=OFF \
                -DBUILD_opencv_apps=OFF -DBUILD_opencv_highgui=OFF -DBUILD_opencv_videoio=OFF \
                -DBUILD_opencv_viz=OFF -DBUILD_opencv_python3=OFF -DBUILD_opencv_python2=OFF \
                -DBUILD_opencv_java=OFF -DBUILD_TESTS=OFF -DBUILD_PERF_TESTS=OFF \
                -DBUILD_EXAMPLES=OFF -DBUILD_DOCS=OFF -DBUILD_SHARED_LIBS=ON \
                -DBUILD_ZLIB=OFF -DBUILD_PNG=OFF -DBUILD_JPEG=OFF -DBUILD_TIFF=OFF \
                -DBUILD_WEBP=OFF -DBUILD_OPENJPEG=OFF -DBUILD_OPENEXR=OFF \
                -DOPENCV_GENERATE_PKGCONFIG=OFF
              ninja -j$(sysctl -n hw.ncpu)
              ninja install
            displayName: '编译 OpenCV'

          - script: |
              set -e
              mkdir -p $HOME/opencv-minimal/lib/pkgconfig
              cat > $HOME/opencv-minimal/lib/pkgconfig/opencv4.pc << 'EOF'
              prefix=${pcfiledir}/../..
              exec_prefix=${prefix}
              libdir=${exec_prefix}/lib
              includedir=${prefix}/include/opencv4

              Name: OpenCV
              Description: Open Source Computer Vision Library
              Version: 4.10.0
              Libs: -L${libdir} -lopencv_core -lopencv_imgproc -lopencv_imgcodecs -lopencv_features2d -lopencv_flann -lopencv_calib3d -lopencv_xfeatures2d
              Cflags: -I${includedir}
              EOF
            displayName: '创建 pkgconfig'

          - script: |
              set -e
              echo "=== 下载 ONNX Runtime ==="
              curl -sL "https://github.com/microsoft/onnxruntime/releases/download/v$(ONNX_VERSION)/onnxruntime-osx-arm64-$(ONNX_VERSION).tgz" | tar xz
              mv onnxruntime-osx-arm64-$(ONNX_VERSION) onnxruntime
              
              echo "=== 下载 OCR 模型 ==="
              mkdir -p models
              git clone --depth 1 https://huggingface.co/getcharzp/go-ocr models/go-ocr-models || true
              if [ -d "models/go-ocr-models" ]; then
                mv models/go-ocr-models/* models/
                rm -rf models/go-ocr-models
              fi
            displayName: '下载运行时和模型'

          - script: |
              set -e
              export PKG_CONFIG_PATH="$HOME/opencv-minimal/lib/pkgconfig"
              export CGO_CPPFLAGS="-I$HOME/opencv-minimal/include/opencv4"
              export CGO_LDFLAGS="-L$HOME/opencv-minimal/lib -Wl,-rpath,@executable_path/../Frameworks"
              
              echo "=== 构建 CLI ==="
              mkdir -p dist
              go build -ldflags "-s -w" -o dist/zoeyworker ./cmd/zoeyworker
              
              echo "=== 构建 GUI ==="
              cd cmd/zoeyworker-gui
              wails build -ldflags "-s -w" -clean
            displayName: '构建应用'

          - script: |
              set -e
              APP_BUNDLE="cmd/zoeyworker-gui/build/bin/ZoeyWorker.app"
              FRAMEWORKS_DIR="${APP_BUNDLE}/Contents/Frameworks"
              RESOURCES_DIR="${APP_BUNDLE}/Contents/Resources"
              EXECUTABLE="${APP_BUNDLE}/Contents/MacOS/ZoeyWorker"
              OPENCV_PREFIX="$HOME/opencv-minimal"
              
              mkdir -p "${FRAMEWORKS_DIR}" "${RESOURCES_DIR}/models"
              cp onnxruntime/lib/*.dylib "${FRAMEWORKS_DIR}/"
              
              for dylib in ${OPENCV_PREFIX}/lib/*.dylib; do
                [ -f "$dylib" ] && [ ! -L "$dylib" ] && cp "$dylib" "${FRAMEWORKS_DIR}/"
              done
              
              # 复制依赖库
              for round in 1 2 3 4 5; do
                changed=0
                for dylib in "${FRAMEWORKS_DIR}"/*.dylib; do
                  [ ! -f "$dylib" ] && continue
                  for dep in $(otool -L "$dylib" 2>/dev/null | grep -E "/opt/homebrew|/usr/local|@rpath" | awk '{print $1}'); do
                    depname=$(basename "$dep")
                    if [ ! -f "${FRAMEWORKS_DIR}/${depname}" ]; then
                      if [[ "$dep" == @rpath* ]]; then
                        found_lib=$(find /opt/homebrew -name "${depname}" 2>/dev/null | head -1)
                      else
                        found_lib="$dep"
                      fi
                      if [ -n "$found_lib" ] && [ -f "$found_lib" ]; then
                        cp -L "$found_lib" "${FRAMEWORKS_DIR}/"
                        changed=1
                      fi
                    fi
                  done
                done
                [ $changed -eq 0 ] && break
              done
              
              # 修复可执行文件依赖路径
              for dep in $(otool -L "$EXECUTABLE" 2>/dev/null | grep -E "/opt/homebrew|/usr/local|$HOME|@rpath" | awk '{print $1}'); do
                libname=$(basename "$dep")
                [ -f "${FRAMEWORKS_DIR}/${libname}" ] && install_name_tool -change "$dep" "@executable_path/../Frameworks/${libname}" "$EXECUTABLE" 2>/dev/null || true
              done
              
              # 修复动态库依赖路径
              for dylib in "${FRAMEWORKS_DIR}"/*.dylib; do
                [ ! -f "$dylib" ] && continue
                libname=$(basename "$dylib")
                install_name_tool -id "@executable_path/../Frameworks/${libname}" "$dylib" 2>/dev/null || true
                for dep in $(otool -L "$dylib" 2>/dev/null | grep -E "@rpath|/opt/homebrew|/usr/local|$HOME" | awk '{print $1}'); do
                  depname=$(basename "$dep")
                  [ -f "${FRAMEWORKS_DIR}/${depname}" ] && install_name_tool -change "$dep" "@executable_path/../Frameworks/${depname}" "$dylib" 2>/dev/null || true
                done
              done
              
              cp -r models/* "${RESOURCES_DIR}/models/" 2>/dev/null || true
              codesign --force --deep --sign - "$APP_BUNDLE" 2>/dev/null || true
              
              mkdir -p $(Build.ArtifactStagingDirectory)
              mv "$APP_BUNDLE" $(Build.ArtifactStagingDirectory)/
              mv dist/zoeyworker $(Build.ArtifactStagingDirectory)/ZoeyWorker.app/Contents/MacOS/zoeyworker-cli
              
              cd $(Build.ArtifactStagingDirectory)
              zip -r ZoeyWorker-darwin-arm64.zip ZoeyWorker.app
              rm -rf ZoeyWorker.app
              ls -lh
            displayName: '打包 App Bundle'

          - publish: $(Build.ArtifactStagingDirectory)/ZoeyWorker-darwin-arm64.zip
            artifact: macos-arm64
            displayName: '发布 macOS 产物'

      # ==================== Windows x64 构建 ====================
      - job: Windows
        pool:
          vmImage: 'windows-latest'
        timeoutInMinutes: 120
        steps:
          - task: GoTool@0
            inputs:
              version: '$(GO_VERSION)'
            displayName: '安装 Go'

          - powershell: |
              choco install cmake ninja mingw -y
              refreshenv
            displayName: '安装构建工具'

          - powershell: |
              go install github.com/wailsapp/wails/v2/cmd/wails@latest
              $env:PATH = "$env:USERPROFILE\go\bin;$env:PATH"
              echo "##vso[task.prependpath]$env:USERPROFILE\go\bin"
            displayName: '安装 Wails'

          - powershell: |
              Write-Host "=== 下载 OpenCV ==="
              Invoke-WebRequest -Uri "https://github.com/opencv/opencv/archive/refs/tags/$(OPENCV_VERSION).tar.gz" -OutFile opencv.tar.gz
              tar -xzf opencv.tar.gz
              Invoke-WebRequest -Uri "https://github.com/opencv/opencv_contrib/archive/refs/tags/$(OPENCV_VERSION).tar.gz" -OutFile opencv_contrib.tar.gz
              tar -xzf opencv_contrib.tar.gz
              
              Write-Host "=== 编译 OpenCV ==="
              mkdir opencv-$(OPENCV_VERSION)\build -Force
              cd opencv-$(OPENCV_VERSION)\build
              
              $env:PATH = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin;$env:PATH"
              
              cmake .. -G "Ninja" `
                -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_INSTALL_PREFIX=C:\opencv-minimal `
                -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ `
                -DOPENCV_EXTRA_MODULES_PATH=..\..\opencv_contrib-$(OPENCV_VERSION)\modules `
                -DBUILD_LIST=core,imgproc,imgcodecs,features2d,flann,calib3d,xfeatures2d `
                -DWITH_QT=OFF -DWITH_GTK=OFF -DWITH_FFMPEG=OFF -DWITH_GSTREAMER=OFF `
                -DWITH_VTK=OFF -DWITH_OPENGL=OFF -DWITH_OPENCL=OFF `
                -DWITH_IPP=OFF -DWITH_TBB=OFF -DWITH_LAPACK=OFF `
                -DBUILD_opencv_apps=OFF -DBUILD_opencv_highgui=OFF -DBUILD_opencv_videoio=OFF `
                -DBUILD_opencv_viz=OFF -DBUILD_opencv_python3=OFF -DBUILD_opencv_python2=OFF `
                -DBUILD_opencv_java=OFF -DBUILD_TESTS=OFF -DBUILD_PERF_TESTS=OFF `
                -DBUILD_EXAMPLES=OFF -DBUILD_DOCS=OFF -DBUILD_SHARED_LIBS=ON `
                -DBUILD_ZLIB=ON -DBUILD_PNG=ON -DBUILD_JPEG=ON -DBUILD_TIFF=ON `
                -DBUILD_WEBP=ON -DBUILD_OPENJPEG=ON -DBUILD_OPENEXR=ON `
                -DOPENCV_GENERATE_PKGCONFIG=OFF
              
              ninja -j$env:NUMBER_OF_PROCESSORS
              ninja install
            displayName: '编译 OpenCV'

          - powershell: |
              mkdir C:\opencv-minimal\lib\pkgconfig -Force
              @"
              prefix=C:/opencv-minimal
              exec_prefix=`${prefix}
              libdir=`${exec_prefix}/x64/mingw/bin
              includedir=`${prefix}/include

              Name: OpenCV
              Description: Open Source Computer Vision Library
              Version: 4.10.0
              Libs: -L`${libdir} -lopencv_core4100 -lopencv_imgproc4100 -lopencv_imgcodecs4100 -lopencv_features2d4100 -lopencv_flann4100 -lopencv_calib3d4100 -lopencv_xfeatures2d4100
              Cflags: -I`${includedir}
              "@ | Out-File -FilePath C:\opencv-minimal\lib\pkgconfig\opencv4.pc -Encoding utf8
            displayName: '创建 pkgconfig'

          - powershell: |
              Write-Host "=== 下载 ONNX Runtime ==="
              Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v$(ONNX_VERSION)/onnxruntime-win-x64-$(ONNX_VERSION).zip" -OutFile onnxruntime.zip
              Expand-Archive onnxruntime.zip -DestinationPath .
              Rename-Item onnxruntime-win-x64-$(ONNX_VERSION) onnxruntime
              
              Write-Host "=== 下载 OCR 模型 ==="
              mkdir models -Force
              git clone --depth 1 https://huggingface.co/getcharzp/go-ocr models/go-ocr-models
              if (Test-Path models/go-ocr-models) {
                Move-Item models/go-ocr-models/* models/ -Force -ErrorAction SilentlyContinue
                Remove-Item models/go-ocr-models -Recurse -Force -ErrorAction SilentlyContinue
              }
            displayName: '下载运行时和模型'

          - powershell: |
              $env:PATH = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin;$env:USERPROFILE\go\bin;$env:PATH"
              $env:PKG_CONFIG_PATH = "C:\opencv-minimal\lib\pkgconfig"
              $env:CGO_CPPFLAGS = "-IC:\opencv-minimal\include"
              $env:CGO_LDFLAGS = "-LC:\opencv-minimal\x64\mingw\bin"
              
              Write-Host "=== 构建 CLI ==="
              mkdir dist -Force
              go build -ldflags "-s -w" -o dist\zoeyworker.exe .\cmd\zoeyworker
              
              Write-Host "=== 构建 GUI ==="
              cd cmd\zoeyworker-gui
              wails build -ldflags "-s -w" -clean
            displayName: '构建应用'

          - powershell: |
              $DIST_DIR = "$(Build.ArtifactStagingDirectory)\ZoeyWorker-windows-amd64"
              mkdir $DIST_DIR -Force
              
              # 复制可执行文件
              Copy-Item cmd\zoeyworker-gui\build\bin\ZoeyWorker.exe $DIST_DIR\
              Copy-Item dist\zoeyworker.exe $DIST_DIR\zoeyworker-cli.exe
              
              # 复制 OpenCV DLLs
              Get-ChildItem C:\opencv-minimal\x64\mingw\bin\*.dll | Copy-Item -Destination $DIST_DIR\
              
              # 复制 ONNX Runtime
              Copy-Item onnxruntime\lib\*.dll $DIST_DIR\
              
              # 复制 MinGW 运行时
              $mingwBin = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
              @("libgcc_s_seh-1.dll", "libstdc++-6.dll", "libwinpthread-1.dll") | ForEach-Object {
                $path = Join-Path $mingwBin $_
                if (Test-Path $path) { Copy-Item $path $DIST_DIR\ }
              }
              
              # 复制模型
              mkdir $DIST_DIR\models -Force
              Copy-Item models\* $DIST_DIR\models\ -Recurse -ErrorAction SilentlyContinue
              
              # 打包
              Compress-Archive -Path $DIST_DIR -DestinationPath "$(Build.ArtifactStagingDirectory)\ZoeyWorker-windows-amd64.zip"
              Remove-Item $DIST_DIR -Recurse -Force
              Get-ChildItem $(Build.ArtifactStagingDirectory)
            displayName: '打包分发包'

          - publish: $(Build.ArtifactStagingDirectory)/ZoeyWorker-windows-amd64.zip
            artifact: windows-amd64
            displayName: '发布 Windows 产物'
