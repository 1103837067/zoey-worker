name: Build ZoeyWorker

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  GO_VERSION: '1.23'
  ONNX_VERSION: '1.19.2'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false  # 禁用缓存避免 gtar 问题

      - name: Install Build Dependencies
        run: |
          brew install cmake ninja pkg-config jpeg-turbo libpng libtiff webp openjpeg zlib || true
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build OpenCV from source (minimal, no Qt/FFmpeg/highgui)
        run: |
          OPENCV_VERSION="4.10.0"
          
          echo "=== Downloading OpenCV ${OPENCV_VERSION} ==="
          curl -sL "https://github.com/opencv/opencv/archive/refs/tags/${OPENCV_VERSION}.tar.gz" | tar xz
          curl -sL "https://github.com/opencv/opencv_contrib/archive/refs/tags/${OPENCV_VERSION}.tar.gz" | tar xz
          
          echo "=== Building OpenCV (minimal modules only) ==="
          mkdir -p opencv-${OPENCV_VERSION}/build
          cd opencv-${OPENCV_VERSION}/build
          
          # 使用系统库避免兼容性问题 (Xcode 16.4 + 内置 zlib 冲突)
          # CMAKE_POLICY_VERSION_MINIMUM 绕过 CMake 版本检查问题
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$HOME/opencv-minimal \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-${OPENCV_VERSION}/modules \
            -DBUILD_LIST=core,imgproc,imgcodecs,features2d,flann,calib3d,xfeatures2d \
            -DWITH_QT=OFF \
            -DWITH_GTK=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_GSTREAMER=OFF \
            -DWITH_AVFOUNDATION=OFF \
            -DWITH_VTK=OFF \
            -DWITH_OPENGL=OFF \
            -DWITH_OPENCL=OFF \
            -DBUILD_opencv_highgui=OFF \
            -DBUILD_opencv_videoio=OFF \
            -DBUILD_opencv_viz=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_python2=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_ZLIB=OFF \
            -DBUILD_PNG=OFF \
            -DBUILD_JPEG=OFF \
            -DBUILD_TIFF=OFF \
            -DBUILD_WEBP=OFF \
            -DBUILD_OPENJPEG=OFF \
            -DBUILD_OPENEXR=OFF \
            -DOPENCV_GENERATE_PKGCONFIG=ON
          
          ninja -j$(sysctl -n hw.ncpu)
          ninja install
          
          echo "=== OpenCV build complete ==="
          ls -la $HOME/opencv-minimal/lib/
          
      - name: Download ONNX Runtime & OCR Models
        run: |
          curl -sL "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-osx-arm64-${ONNX_VERSION}.tgz" | tar xz
          mv onnxruntime-osx-arm64-${ONNX_VERSION} onnxruntime
          
          mkdir -p models
          git clone --depth 1 https://huggingface.co/getcharzp/go-ocr models/go-ocr-models || true
          if [ -d "models/go-ocr-models" ]; then
            mv models/go-ocr-models/* models/
            rm -rf models/go-ocr-models
          fi

      - name: Build CLI
        run: |
          export PKG_CONFIG_PATH="$HOME/opencv-minimal/lib/pkgconfig"
          export CGO_CPPFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_LDFLAGS="-L$HOME/opencv-minimal/lib"
          
          mkdir -p dist
          go build -ldflags "-s -w" -o dist/zoeyworker ./cmd/zoeyworker

      - name: Build GUI App
        run: |
          export PKG_CONFIG_PATH="$HOME/opencv-minimal/lib/pkgconfig"
          export CGO_CPPFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_LDFLAGS="-L$HOME/opencv-minimal/lib"
          
          cd cmd/zoeyworker-gui
          wails build -ldflags "-s -w" -clean

      - name: Package Self-Contained App
        run: |
          APP_BUNDLE="cmd/zoeyworker-gui/build/bin/ZoeyWorker.app"
          FRAMEWORKS_DIR="${APP_BUNDLE}/Contents/Frameworks"
          RESOURCES_DIR="${APP_BUNDLE}/Contents/Resources"
          EXECUTABLE="${APP_BUNDLE}/Contents/MacOS/ZoeyWorker"
          OPENCV_PREFIX="$HOME/opencv-minimal"
          
          mkdir -p "${FRAMEWORKS_DIR}"
          mkdir -p "${RESOURCES_DIR}/models"
          
          echo "=== Copying ONNX Runtime ==="
          cp onnxruntime/lib/*.dylib "${FRAMEWORKS_DIR}/"
          
          echo "=== Copying OpenCV dylibs (self-built, no highgui/videoio) ==="
          for dylib in ${OPENCV_PREFIX}/lib/*.dylib; do
            [ -f "$dylib" ] && [ ! -L "$dylib" ] && cp "$dylib" "${FRAMEWORKS_DIR}/"
          done
          
          echo "=== Copying transitive dependencies ==="
          for round in 1 2 3 4 5; do
            echo "Round $round..."
            changed=0
            for dylib in "${FRAMEWORKS_DIR}"/*.dylib; do
              for dep in $(otool -L "$dylib" 2>/dev/null | grep -E "/opt/homebrew|/usr/local|@rpath" | awk '{print $1}'); do
                depname=$(basename "$dep")
                if [ ! -f "${FRAMEWORKS_DIR}/${depname}" ]; then
                  if [[ "$dep" == @rpath* ]]; then
                    found_lib=$(find /opt/homebrew -name "${depname}" 2>/dev/null | head -1)
                  else
                    found_lib="$dep"
                  fi
                  if [ -n "$found_lib" ] && [ -f "$found_lib" ]; then
                    echo "  Copying: $depname"
                    cp -L "$found_lib" "${FRAMEWORKS_DIR}/"
                    changed=1
                  fi
                fi
              done
            done
            [ $changed -eq 0 ] && break
          done
          
          echo "=== Fixing paths ==="
          for dep in $(otool -L "$EXECUTABLE" | grep -E "/opt/homebrew|/usr/local|$HOME" | awk '{print $1}'); do
            libname=$(basename "$dep")
            [ -f "${FRAMEWORKS_DIR}/${libname}" ] && \
              install_name_tool -change "$dep" "@executable_path/../Frameworks/${libname}" "$EXECUTABLE" 2>/dev/null || true
          done
          
          for dylib in "${FRAMEWORKS_DIR}"/*.dylib; do
            libname=$(basename "$dylib")
            install_name_tool -id "@executable_path/../Frameworks/${libname}" "$dylib" 2>/dev/null || true
            for dep in $(otool -L "$dylib" 2>/dev/null | grep -E "@rpath|/opt/homebrew|/usr/local|$HOME" | awk '{print $1}'); do
              depname=$(basename "$dep")
              [ -f "${FRAMEWORKS_DIR}/${depname}" ] && \
                install_name_tool -change "$dep" "@executable_path/../Frameworks/${depname}" "$dylib" 2>/dev/null || true
            done
          done
          
          echo "=== Copying OCR models ==="
          cp -r models/* "${RESOURCES_DIR}/models/" 2>/dev/null || true
          
          echo "=== Signing ==="
          codesign --force --deep --sign - "$APP_BUNDLE" 2>/dev/null || true
          
          mkdir -p dist
          mv "$APP_BUNDLE" dist/
          mv dist/zoeyworker dist/ZoeyWorker.app/Contents/MacOS/zoeyworker-cli
          
          cd dist
          echo "=== Final size ==="
          du -sh ZoeyWorker.app
          echo "Frameworks:"
          ls -la ZoeyWorker.app/Contents/Frameworks/
          
          zip -r ZoeyWorker-darwin-arm64.zip ZoeyWorker.app
          rm -rf ZoeyWorker.app
          ls -lh

      - uses: actions/upload-artifact@v4
        with:
          name: zoeyworker-darwin-arm64
          path: dist/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false  # 禁用缓存避免问题

      - name: Get Go paths
        id: go-paths
        shell: pwsh
        run: |
          $goRoot = (go env GOROOT) -replace '\\', '/' -replace '^C:', '/c'
          $goPath = (go env GOPATH) -replace '\\', '/' -replace '^C:', '/c'
          echo "GOROOT=$goRoot" >> $env:GITHUB_OUTPUT
          echo "GOPATH=$goPath" >> $env:GITHUB_OUTPUT

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-libtiff
            mingw-w64-x86_64-libwebp
            mingw-w64-x86_64-openjpeg2
            mingw-w64-x86_64-zlib
            zip
            unzip
            wget
            git

      - name: Build OpenCV from source (minimal, no Qt/FFmpeg/highgui)
        shell: msys2 {0}
        run: |
          OPENCV_VERSION="4.10.0"
          
          echo "=== Downloading OpenCV ${OPENCV_VERSION} ==="
          wget -q "https://github.com/opencv/opencv/archive/refs/tags/${OPENCV_VERSION}.tar.gz" -O opencv.tar.gz
          wget -q "https://github.com/opencv/opencv_contrib/archive/refs/tags/${OPENCV_VERSION}.tar.gz" -O opencv_contrib.tar.gz
          tar xzf opencv.tar.gz
          tar xzf opencv_contrib.tar.gz
          
          echo "=== Building OpenCV (minimal modules only) ==="
          mkdir -p opencv-${OPENCV_VERSION}/build
          cd opencv-${OPENCV_VERSION}/build
          
          # 只编译需要的模块，完全禁用 GUI/视频/Qt/FFmpeg
          # 使用系统库避免兼容性问题
          # CMAKE_POLICY_VERSION_MINIMUM 绕过 CMake 版本检查问题
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/mingw64 \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
            -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-${OPENCV_VERSION}/modules \
            -DBUILD_LIST=core,imgproc,imgcodecs,features2d,flann,calib3d,xfeatures2d \
            -DWITH_QT=OFF \
            -DWITH_GTK=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_GSTREAMER=OFF \
            -DWITH_V4L=OFF \
            -DWITH_DSHOW=OFF \
            -DWITH_MSMF=OFF \
            -DWITH_VTK=OFF \
            -DWITH_OPENGL=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_CUDA=OFF \
            -DBUILD_opencv_highgui=OFF \
            -DBUILD_opencv_videoio=OFF \
            -DBUILD_opencv_viz=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_python2=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_TESTS=OFF \
            -DBUILD_PERF_TESTS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -DBUILD_DOCS=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_ZLIB=OFF \
            -DBUILD_PNG=OFF \
            -DBUILD_JPEG=OFF \
            -DBUILD_TIFF=OFF \
            -DBUILD_WEBP=OFF \
            -DBUILD_OPENJPEG=OFF \
            -DBUILD_OPENEXR=OFF \
            -DOPENCV_GENERATE_PKGCONFIG=ON
          
          ninja -j$(nproc)
          ninja install
          
          echo "=== OpenCV build complete ==="
          ls -la /mingw64/bin/libopencv*.dll
          pkg-config --modversion opencv4

      - name: Download ONNX Runtime & OCR Models
        shell: msys2 {0}
        run: |
          # 下载 ONNX Runtime
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-win-x64-${ONNX_VERSION}.zip" -O onnxruntime.zip
          unzip -q onnxruntime.zip
          mv onnxruntime-win-x64-${ONNX_VERSION} onnxruntime
          
          # 下载 OCR 模型
          mkdir -p models
          git clone --depth 1 https://huggingface.co/getcharzp/go-ocr models/go-ocr-models || true
          if [ -d "models/go-ocr-models" ]; then
            mv models/go-ocr-models/* models/
            rm -rf models/go-ocr-models
          fi
          
          echo "Dependencies downloaded:"
          ls -la onnxruntime/lib/
          ls -la models/

      - name: Build
        shell: msys2 {0}
        env:
          GOROOT: ${{ steps.go-paths.outputs.GOROOT }}
          GOPATH: ${{ steps.go-paths.outputs.GOPATH }}
        run: |
          export PATH="$GOROOT/bin:$GOPATH/bin:/mingw64/bin:$PATH"
          
          # OpenCV 配置
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig"
          export CGO_ENABLED=1
          export CGO_CFLAGS="$(pkg-config --cflags opencv4)"
          export CGO_LDFLAGS="$(pkg-config --libs opencv4)"
          export CGO_CPPFLAGS="$CGO_CFLAGS"
          export CGO_CXXFLAGS="$CGO_CFLAGS"
          export OPENCV_GO_SKIP_LINKING=1
          
          mkdir -p dist
          
          # 构建 CLI
          go build -tags customenv -ldflags "-s -w -H windowsgui" -o dist/zoeyworker-cli.exe ./cmd/zoeyworker
          
          # 构建 GUI
          cd cmd/zoeyworker-gui
          wails build -tags customenv -skipbindings -ldflags "-s -w"
          cp build/bin/ZoeyWorker.exe ../../dist/

      - name: Package Self-Contained Distribution
        shell: msys2 {0}
        run: |
          set -e
          
          # 检查 exe 是否存在
          if ! ls dist/*.exe 1>/dev/null 2>&1; then
            echo "ERROR: No .exe files found in dist/"
            exit 1
          fi
          
          echo "=== Collecting all dependencies ==="
          
          # 递归复制 DLL 依赖
          copy_deps() {
            local file="$1"
            [ ! -f "$file" ] && return
            for dll in $(ldd "$file" 2>/dev/null | grep -i mingw64 | awk '{print $3}'); do
              local dllname=$(basename "$dll")
              if [ -n "$dll" ] && [ -f "$dll" ] && [ ! -f "dist/$dllname" ]; then
                echo "Copying: $dllname"
                cp "$dll" dist/ && copy_deps "$dll"
              fi
            done
          }
          
          # 复制 exe 的直接依赖
          for exe in dist/*.exe; do
            echo "Processing: $exe"
            copy_deps "$exe"
          done
          
          # === 复制 ldd 无法检测到的运行时依赖 ===
          
          echo "=== Copying ONNX Runtime (purego dynamic loading) ==="
          cp onnxruntime/lib/*.dll dist/ 2>/dev/null || true
          
          echo "=== Copying OpenCV DLLs (self-built, no highgui/videoio) ==="
          # 自编译的 OpenCV 只有我们需要的模块，直接复制全部
          for dll in /mingw64/bin/libopencv*.dll; do
            [ -f "$dll" ] && cp "$dll" dist/
          done
          
          echo "=== Copying MinGW runtime ==="
          for dll in /mingw64/bin/libgcc_s_seh-1.dll \
                     /mingw64/bin/libstdc++-6.dll \
                     /mingw64/bin/libwinpthread-1.dll \
                     /mingw64/bin/libgomp-1.dll; do
            [ -f "$dll" ] && [ ! -f "dist/$(basename $dll)" ] && cp "$dll" dist/
          done
          
          echo "=== Copying image codec libraries ==="
          for pattern in "libjpeg*.dll" "libpng*.dll" "libtiff*.dll" "libwebp*.dll" \
                         "zlib*.dll" "liblzma*.dll" "libzstd*.dll" "libbz2*.dll" \
                         "libdeflate*.dll" "libjbig*.dll" "libLerc*.dll" \
                         "libsharpyuv*.dll" "libopenjp2*.dll"; do
            for dll in /mingw64/bin/$pattern; do
              [ -f "$dll" ] && [ ! -f "dist/$(basename $dll)" ] && cp "$dll" dist/
            done
          done
          
          # OpenEXR (imgcodecs 可能需要)
          for pattern in "libOpenEXR*.dll" "libImath*.dll" "libIex*.dll" "libIlmThread*.dll" "libOpenEXRCore*.dll"; do
            for dll in /mingw64/bin/$pattern; do
              [ -f "$dll" ] && [ ! -f "dist/$(basename $dll)" ] && cp "$dll" dist/
            done
          done
          
          echo "=== Copying TBB (parallel computing) ==="
          for dll in /mingw64/bin/libtbb*.dll; do
            [ -f "$dll" ] && [ ! -f "dist/$(basename $dll)" ] && cp "$dll" dist/
          done
          
          echo "=== Copying OpenBLAS (math) ==="
          for dll in /mingw64/bin/libopenblas*.dll; do
            [ -f "$dll" ] && [ ! -f "dist/$(basename $dll)" ] && cp "$dll" dist/
          done
          
          # gfortran/quadmath (OpenBLAS 依赖)
          for dll in /mingw64/bin/libgfortran*.dll /mingw64/bin/libquadmath*.dll; do
            [ -f "$dll" ] && [ ! -f "dist/$(basename $dll)" ] && cp "$dll" dist/
          done
          
          echo "=== Multi-round dependency check ==="
          for round in 1 2 3 4 5; do
            echo "Round $round: checking dependencies..."
            changed=0
            for dll in dist/*.dll; do
              for dep in $(ldd "$dll" 2>/dev/null | grep -i mingw64 | awk '{print $3}'); do
                depname=$(basename "$dep")
                if [ -n "$dep" ] && [ -f "$dep" ] && [ ! -f "dist/$depname" ]; then
                  echo "  Found missing: $depname"
                  cp "$dep" dist/
                  changed=1
                fi
              done
            done
            [ $changed -eq 0 ] && echo "  No new dependencies found, stopping." && break
          done
          
          echo "=== Copying OCR models ==="
          mkdir -p dist/models
          cp -r models/* dist/models/ 2>/dev/null || true
          
          echo "=== Final package contents ==="
          echo "EXE files:"
          ls -la dist/*.exe
          echo ""
          echo "DLL count: $(ls -1 dist/*.dll 2>/dev/null | wc -l)"
          echo ""
          echo "Models:"
          ls -la dist/models/ 2>/dev/null || echo "No models"
          echo ""
          echo "Total size:"
          du -sh dist/
          
          echo "=== Creating ZIP package ==="
          cd dist
          zip -r ../ZoeyWorker-windows-x64.zip *
          cd ..
          
          # 清理并保留 zip
          rm -rf dist
          mkdir dist
          mv ZoeyWorker-windows-x64.zip dist/
          
          echo "=== Package created successfully ==="
          ls -la dist/

      - uses: actions/upload-artifact@v4
        with:
          name: zoeyworker-windows-amd64
          path: dist/

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.zip
          generate_release_notes: true
