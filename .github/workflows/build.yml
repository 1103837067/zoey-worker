name: Build ZoeyWorker

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  GO_VERSION: '1.23'
  ONNX_VERSION: '1.19.2'
  OPENCV_VERSION: '4.10.0'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install Build Dependencies
        run: |
          brew install pkg-config jpeg-turbo libpng libtiff webp openjpeg zlib || true
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Download Pre-built OpenCV
        run: |
          echo "=== Downloading pre-built OpenCV ${OPENCV_VERSION} ==="
          mkdir -p $HOME/opencv-minimal
          curl -sL "https://github.com/1103837067/zoey-opencv-prebuilt/releases/download/v${OPENCV_VERSION}/opencv-${OPENCV_VERSION}-macos-arm64.tar.gz" | tar xz -C $HOME/opencv-minimal
          echo "=== OpenCV downloaded ==="
          ls -la $HOME/opencv-minimal/lib/

      - name: Download ONNX Runtime & OCR Models
        run: |
          curl -sL "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-osx-arm64-${ONNX_VERSION}.tgz" | tar xz
          mv onnxruntime-osx-arm64-${ONNX_VERSION} onnxruntime
          
          echo "=== Downloading OCR Models (with Git LFS) ==="
          mkdir -p models
          # 安装 git-lfs 并拉取实际文件
          brew install git-lfs || true
          git lfs install
          git clone https://huggingface.co/getcharzp/go-ocr models/go-ocr-models || true
          if [ -d "models/go-ocr-models" ]; then
            cd models/go-ocr-models
            git lfs pull
            cd ../..
            mv models/go-ocr-models/* models/
            rm -rf models/go-ocr-models
          fi
          
          echo "=== Verifying ONNX model sizes ==="
          ls -la models/paddle_weights/ || true
          ls -la models/ddddocr_weights/ || true

      - name: Build CLI
        run: |
          export PKG_CONFIG_PATH="$HOME/opencv-minimal/lib/pkgconfig"
          export CGO_CPPFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_CXXFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_LDFLAGS="-L$HOME/opencv-minimal/lib -lopencv_core -lopencv_imgproc -lopencv_imgcodecs -lopencv_features2d -lopencv_flann -lopencv_calib3d -lopencv_objdetect -lopencv_dnn -lopencv_video -lopencv_photo -lopencv_highgui -lopencv_videoio -Wl,-rpath,@executable_path/../Frameworks"
          
          mkdir -p dist
          go build -tags customenv -ldflags "-s -w" -o dist/zoeyworker ./cmd/zoeyworker

      - name: Build GUI App
        run: |
          export PKG_CONFIG_PATH="$HOME/opencv-minimal/lib/pkgconfig"
          export CGO_CPPFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_CXXFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_LDFLAGS="-L$HOME/opencv-minimal/lib -lopencv_core -lopencv_imgproc -lopencv_imgcodecs -lopencv_features2d -lopencv_flann -lopencv_calib3d -lopencv_objdetect -lopencv_dnn -lopencv_video -lopencv_photo -lopencv_highgui -lopencv_videoio -Wl,-rpath,@executable_path/../Frameworks"
          export DYLD_LIBRARY_PATH="$HOME/opencv-minimal/lib:$DYLD_LIBRARY_PATH"
          
          cd cmd/zoeyworker-gui
          wails build -tags customenv -ldflags "-s -w" -clean

      - name: Package Self-Contained App
        run: |
          set -e
          APP_BUNDLE="cmd/zoeyworker-gui/build/bin/ZoeyWorker.app"
          FRAMEWORKS_DIR="${APP_BUNDLE}/Contents/Frameworks"
          RESOURCES_DIR="${APP_BUNDLE}/Contents/Resources"
          EXECUTABLE="${APP_BUNDLE}/Contents/MacOS/ZoeyWorker"
          OPENCV_PREFIX="$HOME/opencv-minimal"
          
          mkdir -p "${FRAMEWORKS_DIR}"
          mkdir -p "${RESOURCES_DIR}/models"
          
          echo "=== Copying ONNX Runtime ==="
          # 复制带版本号的 dylib
          cp onnxruntime/lib/libonnxruntime.*.dylib "${FRAMEWORKS_DIR}/" 2>/dev/null || true
          # 创建不带版本号的符号链接（代码查找的是 libonnxruntime.dylib）
          cd "${FRAMEWORKS_DIR}"
          for f in libonnxruntime.*.dylib; do
            if [ -f "$f" ] && [ ! -L "$f" ]; then
              ln -sf "$f" libonnxruntime.dylib
              break
            fi
          done
          cd - > /dev/null
          
          echo "=== Copying OpenCV dylibs (only libopencv_*, exclude OrbbecSDK) ==="
          for dylib in ${OPENCV_PREFIX}/lib/libopencv_*.dylib; do
            if [ -f "$dylib" ] && [ ! -L "$dylib" ]; then
              cp "$dylib" "${FRAMEWORKS_DIR}/"
            fi
          done
          
          echo "=== Fixing library paths ==="
          # 修复主程序的库引用
          for dep in $(otool -L "$EXECUTABLE" 2>/dev/null | grep -E "/opt/homebrew|/usr/local|$HOME|@rpath" | awk '{print $1}'); do
            libname=$(basename "$dep")
            if [ -f "${FRAMEWORKS_DIR}/${libname}" ]; then
              install_name_tool -change "$dep" "@executable_path/../Frameworks/${libname}" "$EXECUTABLE" 2>/dev/null || true
            fi
          done
          
          # 修复所有 dylib 的库引用
          for dylib in "${FRAMEWORKS_DIR}"/*.dylib; do
            [ ! -f "$dylib" ] && continue
            libname=$(basename "$dylib")
            install_name_tool -id "@executable_path/../Frameworks/${libname}" "$dylib" 2>/dev/null || true
            for dep in $(otool -L "$dylib" 2>/dev/null | grep -E "@rpath|/opt/homebrew|/usr/local|$HOME" | awk '{print $1}'); do
              depname=$(basename "$dep")
              if [ -f "${FRAMEWORKS_DIR}/${depname}" ]; then
                install_name_tool -change "$dep" "@executable_path/../Frameworks/${depname}" "$dylib" 2>/dev/null || true
              fi
            done
          done
          
          echo "=== Copying OCR models (only essential files) ==="
          mkdir -p "${RESOURCES_DIR}/models"
          # 只复制必需的模型文件，排除 lib、examples、assets、.git 等
          for dir in paddle_weights ddddocr_weights; do
            if [ -d "models/$dir" ]; then
              cp -r "models/$dir" "${RESOURCES_DIR}/models/"
            fi
          done
          # 复制必要的配置文件
          [ -f "models/LICENSE" ] && cp "models/LICENSE" "${RESOURCES_DIR}/models/"
          [ -f "models/README.md" ] && cp "models/README.md" "${RESOURCES_DIR}/models/"
          
          echo "=== Models directory size ==="
          du -sh "${RESOURCES_DIR}/models/"
          du -sh "${RESOURCES_DIR}/models/"/* 2>/dev/null || true
          
          echo "=== Signing ==="
          codesign --force --deep --sign - "$APP_BUNDLE" 2>/dev/null || true
          
          mkdir -p dist
          mv "$APP_BUNDLE" dist/
          mv dist/zoeyworker dist/ZoeyWorker.app/Contents/MacOS/zoeyworker-cli
          
          cd dist
          echo "=== Final package info ==="
          ls -la ZoeyWorker.app/Contents/Frameworks/
          echo "Total dylibs: $(ls -1 ZoeyWorker.app/Contents/Frameworks/*.dylib | wc -l)"
          du -sh ZoeyWorker.app/Contents/Frameworks/
          du -sh ZoeyWorker.app/Contents/Resources/
          du -sh ZoeyWorker.app
          
          echo "=== Verifying dependencies ==="
          otool -L ZoeyWorker.app/Contents/MacOS/ZoeyWorker | grep -E "/opt/homebrew|/usr/local" && echo "WARNING: External deps found!" || echo "OK: Self-contained"
          
          zip -r ZoeyWorker-darwin-arm64.zip ZoeyWorker.app
          rm -rf ZoeyWorker.app
          ls -lh

      - uses: actions/upload-artifact@v4
        with:
          name: zoeyworker-darwin-arm64
          path: dist/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Get Go paths
        id: go-paths
        shell: pwsh
        run: |
          $goRoot = (go env GOROOT) -replace '\\', '/' -replace '^C:', '/c'
          $goPath = (go env GOPATH) -replace '\\', '/' -replace '^C:', '/c'
          echo "GOROOT=$goRoot" >> $env:GITHUB_OUTPUT
          echo "GOPATH=$goPath" >> $env:GITHUB_OUTPUT

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-git-lfs
            zip
            unzip
            wget
            git

      - name: Download Pre-built OpenCV
        shell: msys2 {0}
        run: |
          echo "=== Downloading pre-built OpenCV ${OPENCV_VERSION} ==="
          mkdir -p /c/opencv-minimal
          curl -sL "https://github.com/1103837067/zoey-opencv-prebuilt/releases/download/v${OPENCV_VERSION}/opencv-${OPENCV_VERSION}-windows-x64.zip" -o opencv.zip
          unzip -q opencv.zip -d /c/opencv-minimal
          echo "=== OpenCV directory structure ==="
          ls -la /c/opencv-minimal/
          ls -la /c/opencv-minimal/include/
          ls -la /c/opencv-minimal/x64/mingw/lib/ || echo "Checking alternative lib path..."
          ls -la /c/opencv-minimal/x64/mingw/bin/ || echo "Checking alternative bin path..."

      - name: Download ONNX Runtime & OCR Models
        shell: msys2 {0}
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-win-x64-${ONNX_VERSION}.zip" -O onnxruntime.zip
          unzip -q onnxruntime.zip
          mv onnxruntime-win-x64-${ONNX_VERSION} onnxruntime
          
          echo "=== Downloading OCR Models (with Git LFS) ==="
          mkdir -p models
          # 安装 git-lfs 并拉取实际文件
          git lfs install
          git clone https://huggingface.co/getcharzp/go-ocr models/go-ocr-models || true
          if [ -d "models/go-ocr-models" ]; then
            cd models/go-ocr-models
            git lfs pull
            cd ../..
            mv models/go-ocr-models/* models/
            rm -rf models/go-ocr-models
          fi
          
          echo "Dependencies downloaded:"
          ls -la onnxruntime/lib/
          ls -la models/
          echo "=== Verifying ONNX model sizes ==="
          ls -la models/paddle_weights/ || true
          ls -la models/ddddocr_weights/ || true

      - name: Build
        shell: msys2 {0}
        env:
          GOROOT: ${{ steps.go-paths.outputs.GOROOT }}
          GOPATH: ${{ steps.go-paths.outputs.GOPATH }}
        run: |
          export PATH="$GOROOT/bin:$GOPATH/bin:/mingw64/bin:$PATH"
          
          # Windows OpenCV 目录结构: include/opencv2, x64/mingw/lib, x64/mingw/bin
          export PKG_CONFIG_PATH="/c/opencv-minimal/lib/pkgconfig"
          export CGO_ENABLED=1
          export CGO_CFLAGS="-I/c/opencv-minimal/include"
          export CGO_LDFLAGS="-L/c/opencv-minimal/x64/mingw/lib -lopencv_core4100 -lopencv_imgproc4100 -lopencv_imgcodecs4100 -lopencv_features2d4100 -lopencv_flann4100 -lopencv_calib3d4100 -lopencv_objdetect4100 -lopencv_dnn4100 -lopencv_video4100 -lopencv_photo4100 -lopencv_highgui4100 -lopencv_videoio4100"
          export CGO_CPPFLAGS="$CGO_CFLAGS"
          export CGO_CXXFLAGS="$CGO_CFLAGS"
          export OPENCV_GO_SKIP_LINKING=1
          
          mkdir -p dist
          
          # 构建 CLI
          go build -tags customenv -ldflags "-s -w -H windowsgui" -o dist/zoeyworker-cli.exe ./cmd/zoeyworker
          
          # 构建 GUI
          cd cmd/zoeyworker-gui
          wails build -tags customenv -skipbindings -ldflags "-s -w"
          cp build/bin/ZoeyWorker.exe ../../dist/

      - name: Package Self-Contained Distribution
        shell: msys2 {0}
        run: |
          set -e
          
          if ! ls dist/*.exe 1>/dev/null 2>&1; then
            echo "ERROR: No .exe files found in dist/"
            exit 1
          fi
          
          echo "=== Collecting dependencies ==="
          
          copy_deps() {
            local file="$1"
            [ ! -f "$file" ] && return
            for dll in $(ldd "$file" 2>/dev/null | grep -i mingw64 | awk '{print $3}'); do
              local dllname=$(basename "$dll")
              if [ -n "$dll" ] && [ -f "$dll" ] && [ ! -f "dist/$dllname" ]; then
                echo "Copying: $dllname"
                cp "$dll" dist/ && copy_deps "$dll"
              fi
            done
          }
          
          for exe in dist/*.exe; do
            echo "Processing: $exe"
            copy_deps "$exe"
          done
          
          echo "=== Copying ONNX Runtime ==="
          cp onnxruntime/lib/*.dll dist/ 2>/dev/null || true
          
          echo "=== Copying OpenCV DLLs ==="
          # Windows OpenCV DLL 在 x64/mingw/bin 目录
          for dll in /c/opencv-minimal/x64/mingw/bin/libopencv*.dll; do
            [ -f "$dll" ] && cp "$dll" dist/
          done
          
          echo "=== Copying runtime libraries ==="
          for dll in libgcc_s_seh-1.dll libstdc++-6.dll libwinpthread-1.dll libgomp-1.dll; do
            [ -f "/mingw64/bin/$dll" ] && [ ! -f "dist/$dll" ] && cp "/mingw64/bin/$dll" dist/
          done
          
          echo "=== Multi-round dependency check ==="
          for round in 1 2 3 4 5; do
            echo "Round $round..."
            changed=0
            for dll in dist/*.dll; do
              [ ! -f "$dll" ] && continue
              for dep in $(ldd "$dll" 2>/dev/null | grep -i mingw64 | awk '{print $3}'); do
                depname=$(basename "$dep")
                if [ -n "$dep" ] && [ -f "$dep" ] && [ ! -f "dist/$depname" ]; then
                  echo "  Found missing: $depname"
                  cp "$dep" dist/
                  changed=1
                fi
              done
            done
            [ $changed -eq 0 ] && break
          done
          
          echo "=== Copying OCR models (exclude lib folder) ==="
          mkdir -p dist/models
          for item in models/*; do
            itemname=$(basename "$item")
            # 跳过 lib 目录（ONNX Runtime 已经在 exe 同目录）
            if [ "$itemname" != "lib" ]; then
              cp -r "$item" dist/models/
            fi
          done
          
          echo "=== Final package info ==="
          echo "EXE files:"
          ls -la dist/*.exe
          echo "DLL count: $(ls -1 dist/*.dll 2>/dev/null | wc -l)"
          echo "Total size:"
          du -sh dist/
          
          echo "=== Creating ZIP ==="
          cd dist
          zip -r ../ZoeyWorker-windows-x64.zip *
          cd ..
          
          rm -rf dist
          mkdir dist
          mv ZoeyWorker-windows-x64.zip dist/
          
          echo "=== Done ==="
          ls -la dist/

      - uses: actions/upload-artifact@v4
        with:
          name: zoeyworker-windows-amd64
          path: dist/

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.zip
          generate_release_notes: true
