name: Build ZoeyWorker

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  GO_VERSION: '1.23'
  ONNX_VERSION: '1.23.2'
  OPENCV_VERSION: '4.10.0'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install Build Dependencies
        run: |
          brew install pkg-config jpeg-turbo libpng libtiff webp openjpeg zlib || true
          # Wails v3: 不需要安装 wails CLI，直接用 go build（前端通过 embed 嵌入）

      - name: Download Pre-built OpenCV
        run: |
          echo "=== Downloading pre-built OpenCV ${OPENCV_VERSION} ==="
          mkdir -p $HOME/opencv-minimal
          curl -sL "https://github.com/1103837067/zoey-opencv-prebuilt/releases/download/v${OPENCV_VERSION}/opencv-${OPENCV_VERSION}-macos-arm64.tar.gz" | tar xz -C $HOME/opencv-minimal
          echo "=== OpenCV downloaded ==="
          ls -la $HOME/opencv-minimal/lib/

      - name: Download ONNX Runtime & OCR Models
        run: |
          curl -sL "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-osx-arm64-${ONNX_VERSION}.tgz" | tar xz
          mv onnxruntime-osx-arm64-${ONNX_VERSION} onnxruntime
          
          echo "=== Downloading PP-OCRv4 Mobile Models (lightweight ~16MB) ==="
          mkdir -p models/paddle_weights
          # 从 RapidOCR 仓库下载轻量级 PP-OCRv4 模型（支持中英文）
          # det: 4.75MB, rec: 10.9MB - 比 Server 版本小 15 倍
          curl -sL "https://huggingface.co/SWHL/RapidOCR/resolve/main/PP-OCRv4/ch_PP-OCRv4_det_infer.onnx" -o models/paddle_weights/det.onnx
          curl -sL "https://huggingface.co/SWHL/RapidOCR/resolve/main/PP-OCRv4/ch_PP-OCRv4_rec_infer.onnx" -o models/paddle_weights/rec.onnx
          # 下载字典文件
          curl -sL "https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/main/ppocr/utils/ppocr_keys_v1.txt" -o models/paddle_weights/dict.txt
          
          echo "=== Verifying OCR model sizes ==="
          ls -la models/paddle_weights/

      - name: Build CLI
        run: |
          export PKG_CONFIG_PATH="$HOME/opencv-minimal/lib/pkgconfig"
          export CGO_CPPFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_CXXFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_LDFLAGS="-L$HOME/opencv-minimal/lib -lopencv_core -lopencv_imgproc -lopencv_imgcodecs -lopencv_features2d -lopencv_flann -lopencv_calib3d -lopencv_objdetect -lopencv_dnn -lopencv_video -lopencv_photo -lopencv_highgui -lopencv_videoio -Wl,-rpath,@executable_path/../Frameworks"
          
          mkdir -p dist
          go build -tags customenv -ldflags "-s -w" -o dist/zoeyworker ./cmd/zoeyworker

      - name: Build GUI App (Wails v3)
        run: |
          export PKG_CONFIG_PATH="$HOME/opencv-minimal/lib/pkgconfig"
          export CGO_CPPFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_CXXFLAGS="-I$HOME/opencv-minimal/include/opencv4"
          export CGO_LDFLAGS="-L$HOME/opencv-minimal/lib -lopencv_core -lopencv_imgproc -lopencv_imgcodecs -lopencv_features2d -lopencv_flann -lopencv_calib3d -lopencv_objdetect -lopencv_dnn -lopencv_video -lopencv_photo -lopencv_highgui -lopencv_videoio -Wl,-rpath,@executable_path/../Frameworks"
          export DYLD_LIBRARY_PATH="$HOME/opencv-minimal/lib:$DYLD_LIBRARY_PATH"
          
          cd cmd/zoeyworker-gui
          
          # 准备前端文件（复制到 dist 目录供 embed 使用）
          mkdir -p frontend/dist
          cp frontend/index.html frontend/dist/
          cp frontend/app.js frontend/dist/
          
          # Wails v3: 直接用 go build（前端已经 embed 到代码中）
          go build -tags customenv -ldflags "-s -w" -o ZoeyWorker .
          
          # Create app bundle structure
          mkdir -p build/bin/ZoeyWorker.app/Contents/MacOS
          mkdir -p build/bin/ZoeyWorker.app/Contents/Resources
          cp ZoeyWorker build/bin/ZoeyWorker.app/Contents/MacOS/
          cp build/appicon.png build/bin/ZoeyWorker.app/Contents/Resources/ || true
          cat > build/bin/ZoeyWorker.app/Contents/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>ZoeyWorker</string>
              <key>CFBundleIdentifier</key>
              <string>com.zoey.worker</string>
              <key>CFBundleName</key>
              <string>ZoeyWorker</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleIconFile</key>
              <string>appicon</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSUIElement</key>
              <false/>
          </dict>
          </plist>
          PLIST

      - name: Package Self-Contained App
        run: |
          set -e
          APP_BUNDLE="cmd/zoeyworker-gui/build/bin/ZoeyWorker.app"
          FRAMEWORKS_DIR="${APP_BUNDLE}/Contents/Frameworks"
          RESOURCES_DIR="${APP_BUNDLE}/Contents/Resources"
          EXECUTABLE="${APP_BUNDLE}/Contents/MacOS/ZoeyWorker"
          OPENCV_PREFIX="$HOME/opencv-minimal"
          
          mkdir -p "${FRAMEWORKS_DIR}"
          mkdir -p "${RESOURCES_DIR}/models"
          
          echo "=== Copying ONNX Runtime ==="
          # 复制带版本号的 dylib
          cp onnxruntime/lib/libonnxruntime.*.dylib "${FRAMEWORKS_DIR}/" 2>/dev/null || true
          # 创建不带版本号的符号链接（代码查找的是 libonnxruntime.dylib）
          cd "${FRAMEWORKS_DIR}"
          for f in libonnxruntime.*.dylib; do
            if [ -f "$f" ] && [ ! -L "$f" ]; then
              ln -sf "$f" libonnxruntime.dylib
              break
            fi
          done
          cd - > /dev/null
          
          echo "=== Copying OpenCV dylibs (only libopencv_*, exclude OrbbecSDK) ==="
          for dylib in ${OPENCV_PREFIX}/lib/libopencv_*.dylib; do
            if [ -f "$dylib" ] && [ ! -L "$dylib" ]; then
              cp "$dylib" "${FRAMEWORKS_DIR}/"
            fi
          done
          
          echo "=== Fixing library paths ==="
          # 修复主程序的库引用
          for dep in $(otool -L "$EXECUTABLE" 2>/dev/null | grep -E "/opt/homebrew|/usr/local|$HOME|@rpath" | awk '{print $1}'); do
            libname=$(basename "$dep")
            if [ -f "${FRAMEWORKS_DIR}/${libname}" ]; then
              install_name_tool -change "$dep" "@executable_path/../Frameworks/${libname}" "$EXECUTABLE" 2>/dev/null || true
            fi
          done
          
          # 修复所有 dylib 的库引用
          for dylib in "${FRAMEWORKS_DIR}"/*.dylib; do
            [ ! -f "$dylib" ] && continue
            libname=$(basename "$dylib")
            install_name_tool -id "@executable_path/../Frameworks/${libname}" "$dylib" 2>/dev/null || true
            for dep in $(otool -L "$dylib" 2>/dev/null | grep -E "@rpath|/opt/homebrew|/usr/local|$HOME" | awk '{print $1}'); do
              depname=$(basename "$dep")
              if [ -f "${FRAMEWORKS_DIR}/${depname}" ]; then
                install_name_tool -change "$dep" "@executable_path/../Frameworks/${depname}" "$dylib" 2>/dev/null || true
              fi
            done
          done
          
          echo "=== Copying OCR models ==="
          mkdir -p "${RESOURCES_DIR}/models"
          cp -r models/paddle_weights "${RESOURCES_DIR}/models/"
          
          echo "=== Models directory size ==="
          du -sh "${RESOURCES_DIR}/models/"
          ls -la "${RESOURCES_DIR}/models/paddle_weights/"
          
          echo "=== Signing ==="
          codesign --force --deep --sign - "$APP_BUNDLE" 2>/dev/null || true
          
          mkdir -p dist
          mv "$APP_BUNDLE" dist/
          mv dist/zoeyworker dist/ZoeyWorker.app/Contents/MacOS/zoeyworker-cli
          
          cd dist
          echo "=== Final package info ==="
          ls -la ZoeyWorker.app/Contents/Frameworks/
          echo "Total dylibs: $(ls -1 ZoeyWorker.app/Contents/Frameworks/*.dylib | wc -l)"
          du -sh ZoeyWorker.app/Contents/Frameworks/
          du -sh ZoeyWorker.app/Contents/Resources/
          du -sh ZoeyWorker.app
          
          echo "=== Verifying dependencies ==="
          otool -L ZoeyWorker.app/Contents/MacOS/ZoeyWorker | grep -E "/opt/homebrew|/usr/local" && echo "WARNING: External deps found!" || echo "OK: Self-contained"
          
          echo "=== Verifying OCR components ==="
          echo "ONNX Runtime:"
          ls -la ZoeyWorker.app/Contents/Frameworks/libonnxruntime* || echo "ERROR: ONNX Runtime not found!"
          echo "OCR Models:"
          ls -la ZoeyWorker.app/Contents/Resources/models/paddle_weights/ || echo "ERROR: OCR models not found!"
          # 验证模型文件大小（应该 > 1MB）
          DET_SIZE=$(stat -f%z ZoeyWorker.app/Contents/Resources/models/paddle_weights/det.onnx 2>/dev/null || echo "0")
          REC_SIZE=$(stat -f%z ZoeyWorker.app/Contents/Resources/models/paddle_weights/rec.onnx 2>/dev/null || echo "0")
          echo "det.onnx size: $DET_SIZE bytes"
          echo "rec.onnx size: $REC_SIZE bytes"
          if [ "$DET_SIZE" -lt 1000000 ]; then
            echo "ERROR: det.onnx is too small, might be corrupted!"
            exit 1
          fi
          if [ "$REC_SIZE" -lt 1000000 ]; then
            echo "ERROR: rec.onnx is too small, might be corrupted!"
            exit 1
          fi
          echo "OK: OCR models verified"
          
          zip -r ZoeyWorker-darwin-arm64.zip ZoeyWorker.app
          rm -rf ZoeyWorker.app
          ls -lh

      - uses: actions/upload-artifact@v4
        with:
          name: zoeyworker-darwin-arm64
          path: dist/

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Get Go paths
        id: go-paths
        shell: pwsh
        run: |
          $goRoot = (go env GOROOT) -replace '\\', '/' -replace '^C:', '/c'
          $goPath = (go env GOPATH) -replace '\\', '/' -replace '^C:', '/c'
          echo "GOROOT=$goRoot" >> $env:GITHUB_OUTPUT
          echo "GOPATH=$goPath" >> $env:GITHUB_OUTPUT

      - name: Install Build Tools
        run: |
          # Wails v3: 不需要安装 wails CLI，直接用 go build（前端通过 embed 嵌入）
          echo "Build tools ready"

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkg-config
            zip
            unzip
            wget
            curl

      - name: Download Pre-built OpenCV
        shell: msys2 {0}
        run: |
          echo "=== Downloading pre-built OpenCV ${OPENCV_VERSION} ==="
          mkdir -p /c/opencv-minimal
          curl -sL "https://github.com/1103837067/zoey-opencv-prebuilt/releases/download/v${OPENCV_VERSION}/opencv-${OPENCV_VERSION}-windows-x64.zip" -o opencv.zip
          unzip -q opencv.zip -d /c/opencv-minimal
          echo "=== OpenCV directory structure ==="
          ls -la /c/opencv-minimal/
          ls -la /c/opencv-minimal/include/
          ls -la /c/opencv-minimal/x64/mingw/lib/ || echo "Checking alternative lib path..."
          ls -la /c/opencv-minimal/x64/mingw/bin/ || echo "Checking alternative bin path..."

      - name: Download ONNX Runtime & OCR Models
        shell: msys2 {0}
        run: |
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-win-x64-${ONNX_VERSION}.zip" -O onnxruntime.zip
          unzip -q onnxruntime.zip
          mv onnxruntime-win-x64-${ONNX_VERSION} onnxruntime
          
          echo "=== Downloading PP-OCRv4 Mobile Models (lightweight ~16MB) ==="
          mkdir -p models/paddle_weights
          # 从 RapidOCR 仓库下载轻量级 PP-OCRv4 模型（支持中英文）
          curl -sL "https://huggingface.co/SWHL/RapidOCR/resolve/main/PP-OCRv4/ch_PP-OCRv4_det_infer.onnx" -o models/paddle_weights/det.onnx
          curl -sL "https://huggingface.co/SWHL/RapidOCR/resolve/main/PP-OCRv4/ch_PP-OCRv4_rec_infer.onnx" -o models/paddle_weights/rec.onnx
          # 下载字典文件
          curl -sL "https://raw.githubusercontent.com/PaddlePaddle/PaddleOCR/main/ppocr/utils/ppocr_keys_v1.txt" -o models/paddle_weights/dict.txt
          
          echo "=== Verifying OCR model sizes ==="
          ls -la onnxruntime/lib/
          ls -la models/paddle_weights/

      - name: Build
        shell: msys2 {0}
        env:
          GOROOT: ${{ steps.go-paths.outputs.GOROOT }}
          GOPATH: ${{ steps.go-paths.outputs.GOPATH }}
        run: |
          export PATH="$GOROOT/bin:$GOPATH/bin:/mingw64/bin:$PATH"
          
          # Windows OpenCV 目录结构: include/opencv2, x64/mingw/lib, x64/mingw/bin
          export PKG_CONFIG_PATH="/c/opencv-minimal/lib/pkgconfig"
          export CGO_ENABLED=1
          export CGO_CFLAGS="-I/c/opencv-minimal/include"
          export CGO_LDFLAGS="-L/c/opencv-minimal/x64/mingw/lib -lopencv_core4100 -lopencv_imgproc4100 -lopencv_imgcodecs4100 -lopencv_features2d4100 -lopencv_flann4100 -lopencv_calib3d4100 -lopencv_objdetect4100 -lopencv_dnn4100 -lopencv_video4100 -lopencv_photo4100 -lopencv_highgui4100 -lopencv_videoio4100"
          export CGO_CPPFLAGS="$CGO_CFLAGS"
          export CGO_CXXFLAGS="$CGO_CFLAGS"
          export OPENCV_GO_SKIP_LINKING=1
          
          mkdir -p dist
          
          # 构建 CLI
          go build -tags customenv -ldflags "-s -w -H windowsgui" -o dist/zoeyworker-cli.exe ./cmd/zoeyworker
          
          # 构建 GUI (Wails v3)
          cd cmd/zoeyworker-gui
          # 准备前端文件（复制到 dist 目录供 embed 使用）
          mkdir -p frontend/dist
          cp frontend/index.html frontend/dist/
          cp frontend/app.js frontend/dist/
          GOOS=windows GOARCH=amd64 go build -tags customenv -ldflags "-s -w -H windowsgui" -o ZoeyWorker.exe .
          cp ZoeyWorker.exe ../../dist/

      - name: Package Self-Contained Distribution
        shell: msys2 {0}
        run: |
          set -e
          
          if ! ls dist/*.exe 1>/dev/null 2>&1; then
            echo "ERROR: No .exe files found in dist/"
            exit 1
          fi
          
          echo "=== Collecting dependencies ==="
          
          copy_deps() {
            local file="$1"
            [ ! -f "$file" ] && return
            for dll in $(ldd "$file" 2>/dev/null | grep -i mingw64 | awk '{print $3}'); do
              local dllname=$(basename "$dll")
              if [ -n "$dll" ] && [ -f "$dll" ] && [ ! -f "dist/$dllname" ]; then
                echo "Copying: $dllname"
                cp "$dll" dist/ && copy_deps "$dll"
              fi
            done
          }
          
          for exe in dist/*.exe; do
            echo "Processing: $exe"
            copy_deps "$exe"
          done
          
          echo "=== Copying ONNX Runtime ==="
          cp onnxruntime/lib/*.dll dist/ 2>/dev/null || true
          
          echo "=== Copying OpenCV DLLs ==="
          # Windows OpenCV DLL 在 x64/mingw/bin 目录
          for dll in /c/opencv-minimal/x64/mingw/bin/libopencv*.dll; do
            [ -f "$dll" ] && cp "$dll" dist/
          done
          
          echo "=== Copying runtime libraries ==="
          for dll in libgcc_s_seh-1.dll libstdc++-6.dll libwinpthread-1.dll libgomp-1.dll; do
            [ -f "/mingw64/bin/$dll" ] && [ ! -f "dist/$dll" ] && cp "/mingw64/bin/$dll" dist/
          done
          
          echo "=== Multi-round dependency check ==="
          for round in 1 2 3 4 5; do
            echo "Round $round..."
            changed=0
            for dll in dist/*.dll; do
              [ ! -f "$dll" ] && continue
              for dep in $(ldd "$dll" 2>/dev/null | grep -i mingw64 | awk '{print $3}'); do
                depname=$(basename "$dep")
                if [ -n "$dep" ] && [ -f "$dep" ] && [ ! -f "dist/$depname" ]; then
                  echo "  Found missing: $depname"
                  cp "$dep" dist/
                  changed=1
                fi
              done
            done
            [ $changed -eq 0 ] && break
          done
          
          echo "=== Copying OCR models ==="
          mkdir -p dist/models
          cp -r models/paddle_weights dist/models/
          
          echo "=== Verifying OCR components ==="
          echo "ONNX Runtime:"
          ls -la dist/onnxruntime.dll || echo "ERROR: ONNX Runtime not found!"
          echo "OCR Models:"
          ls -la dist/models/paddle_weights/
          # 验证模型文件大小（应该 > 1MB）
          DET_SIZE=$(stat -c%s dist/models/paddle_weights/det.onnx 2>/dev/null || echo "0")
          REC_SIZE=$(stat -c%s dist/models/paddle_weights/rec.onnx 2>/dev/null || echo "0")
          echo "det.onnx size: $DET_SIZE bytes"
          echo "rec.onnx size: $REC_SIZE bytes"
          if [ "$DET_SIZE" -lt 1000000 ]; then
            echo "ERROR: det.onnx is too small, might be corrupted!"
            exit 1
          fi
          if [ "$REC_SIZE" -lt 1000000 ]; then
            echo "ERROR: rec.onnx is too small, might be corrupted!"
            exit 1
          fi
          echo "OK: OCR models verified"
          
          echo "=== Final package info ==="
          echo "EXE files:"
          ls -la dist/*.exe
          echo "DLL count: $(ls -1 dist/*.dll 2>/dev/null | wc -l)"
          echo "Total size:"
          du -sh dist/
          
          echo "=== Creating ZIP ==="
          cd dist
          zip -r ../ZoeyWorker-windows-x64.zip *
          cd ..
          
          rm -rf dist
          mkdir dist
          mv ZoeyWorker-windows-x64.zip dist/
          
          echo "=== Done ==="
          ls -la dist/

      - uses: actions/upload-artifact@v4
        with:
          name: zoeyworker-windows-amd64
          path: dist/

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.zip
          generate_release_notes: true
